name: ç¼–è¯‘æµ‹è¯•
# è¯¥è„šæœ¬ä»…åœ¨ PR MERGE çš„æ—¶å€™è¿›è¡Œæµ‹è¯•ï¼Œä¸å»ºè®® å°†æµ‹è¯•ç»“æœä¸Šä¼ åˆ° github
# å¯ä»¥é€šè¿‡å˜é‡æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚ PR close çš„æ—¶å€™ å‘å¸ƒ github release & tag

on:
  pull_request:
    branches:
      - master # æ­£å¼ç‰ˆæœ¬
    types:
      - closed
      - opened
      - synchronize
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions: write-all

env:
  TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }} # TODO è¯·åœ¨ secrets ä¸­è®¾ç½® TOKEN_GITHUB å¹¶ä¸” TOKEN æœ‰æƒé™å‘å¸ƒ release & tag & pr & issue

jobs:
  like_admin:
    name: ç¼–è¯‘åç«¯
    runs-on: ubuntu-latest
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: ç¼–è¯‘
        run: |
          cd ./server
          mvn clean install -Dmaven.test.skip=true -f pom.xml
          find ${PWD} -name "*.jar" -exec zip -j like-admin.zip {} +


      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: like-admin.zip
          path: server/like-admin.zip
          retention-days: 5

      - name: æŸ¥æ‰¾é€šçŸ¥
        uses: peter-evans/find-comment@v2
        if: github.repository_owner	== github.actor
        id: fc
        with:
          token: ${{ env.TOKEN_GITHUB }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: ${{ github.actor }}
          body-includes: 'Automated changes by' # æ³¨æ„è¯¥æ–‡å­—è¦å­˜åœ¨äº æ›´æ–°è¯„è®º ä¸­çš„ body

      - name: æ›´æ–°é€šçŸ¥
        uses: peter-evans/create-or-update-comment@v3
        if: github.repository_owner	== github.actor # åªæœ‰ä»“åº“æ‹¥æœ‰è€…æ‰ä¼šæ”¶åˆ°é€šçŸ¥
        with:
          token: ${{ env.TOKEN_GITHUB }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: append
          reactions-edit-mode: append
          body: "âœ…: ç¼–è¯‘åç«¯æˆåŠŸ"


  uniapp:
    runs-on: ubuntu-latest
    name: ç¼–è¯‘å‰ç«¯
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® node ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: æ‰“åŒ…
        run: |
          cd ./uniapp
          npm install
          npm run build:h5
          cd ..
          zip -rj uniapp.zip ./h5


      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        id: artifact-upload-step
        with:
          name: uniapp.zip
          path: uniapp.zip
          retention-days: 5

      - name: æŸ¥æ‰¾é€šçŸ¥
        uses: peter-evans/find-comment@v2
        if: github.repository_owner	== github.actor
        id: fc
        with:
          token: ${{ env.TOKEN_GITHUB }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: ${{ github.actor }}
          body-includes: 'Automated changes by' # æ³¨æ„è¯¥æ–‡å­—è¦å­˜åœ¨äº æ›´æ–°è¯„è®º ä¸­çš„ body

      - name: æ›´æ–°é€šçŸ¥
        uses: peter-evans/create-or-update-comment@v3
        if: github.repository_owner	== github.actor # åªæœ‰ä»“åº“æ‹¥æœ‰è€…æ‰ä¼šæ”¶åˆ°é€šçŸ¥
        with:
          token: ${{ env.TOKEN_GITHUB }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: append
          reactions-edit-mode: append
          body: "âœ…: ç¼–è¯‘å‰ç«¯æˆåŠŸ"

  Make_Release:
    # è¯¥ä»»åŠ¡å¯åœ¨ merge ä¹Ÿå°±æ˜¯ pr clone çš„æ—¶å€™ è¿›è¡Œä¸Šä¼ ä»»åŠ¡ å½“ç„¶ä¹Ÿå¯ä»¥åˆå¹¶æˆä¸€ä¸ª cli
    needs: [ like_admin, uniapp ]
    #    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && (github.event.pull_request.merge_commit_sha != '' || github.event.pull_request.merged == true))
    name: å‘å¸ƒç¼–è¯‘å¥½çš„è½¯ä»¶
    runs-on: ubuntu-latest
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æµ‹æƒé™
        run: |
          if [ "${{ env.TOKEN_GITHUB }}" == "" ]; then
            echo "TOKEN_GITHUB=${{ github.token }}" >> $GITHUB_ENV
            echo "âŒ æœªè®¾ç½® secrets.TOKEN_GITHUB å¯†ç "
          fi

      - name: ä¸‹è½½
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          path: ./
          merge-multiple: true

      - name: è§£å‹
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
        run: |
          unzip like-admin.zip -d ./dist
          mv uniapp.zip ./dist

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true # åªæœ‰è¢«åˆå¹¶çš„ pr æ‰ä¼š å‘å¸ƒ
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ env.TOKEN_GITHUB }}

      - name: å‘å¸ƒ
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true # åªæœ‰è¢«åˆå¹¶çš„ pr æ‰ä¼š å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          files: "dist/**"
          body: "Update ${{ steps.tag_version.outputs.new_tag }}"
          name: "Release ${{ steps.tag_version.outputs.new_tag }}"
          tag_name: "${{ steps.tag_version.outputs.new_tag }}"
          draft: false
          token: ${{ env.TOKEN_GITHUB }}

      - name: æŸ¥æ‰¾é€šçŸ¥
        uses: peter-evans/find-comment@v2
        id: fc
        with:
          token: ${{ env.TOKEN_GITHUB }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: ${{ github.actor }}
          body-includes: 'Automated changes by' # æ³¨æ„è¯¥æ–‡å­—è¦å­˜åœ¨äº æ›´æ–°è¯„è®º ä¸­çš„ body

      - name: æ›´æ–°é€šçŸ¥
        uses: peter-evans/create-or-update-comment@v3
        if: github.repository_owner	== github.actor # åªæœ‰ä»“åº“æ‹¥æœ‰è€…æ‰ä¼šæ”¶åˆ°é€šçŸ¥
        with:
          token: ${{ env.TOKEN_GITHUB }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: append
          reactions-edit-mode: append
          body: |
            âœ…: é€šçŸ¥åŠ è½½å®Œæˆ
            
            ğŸ‘¤: @${{ github.actor }} 
            ğŸ“¦: ${{ steps.tag_version.outputs.new_tag }}
            ğŸ›œ: 
              - [like-admin-1.0.0](/${{ github.repository }}/releases/download/${{ steps.tag_version.outputs.new_tag }}/like-admin-1.0.0.jar)
              - [like-common-1.0.0](/${{ github.repository }}/releases/download/${{ steps.tag_version.outputs.new_tag }}/like-common-1.0.0.jar)
              - [like-front-1.0.0](/${{ github.repository }}/releases/download/${{ steps.tag_version.outputs.new_tag }}/like-front-1.0.0.jar)
              - [like-generator-1.0.0](/${{ github.repository }}/releases/download/${{ steps.tag_version.outputs.new_tag }}/like-generator-1.0.0.jar)
              - [uniapp](/${{ github.repository }}/releases/download/${{ steps.tag_version.outputs.new_tag }}/uniapp.zip)
            ğŸ“”: 
              - [**Actions æ—¥å¿—**](../actions/runs/${{ github.run_id }})
              - [**æäº¤ä¿¡æ¯**](../commits/${{ github.sha }})</sup>
          
            <br>
