name: ç¼–è¯‘æµ‹è¯•
# è¯¥è„šæœ¬ä»…åœ¨ PR MERGE çš„æ—¶å€™è¿›è¡Œæµ‹è¯•ï¼Œä¸å»ºè®® å°†æµ‹è¯•ç»“æœä¸Šä¼ åˆ° github
# å¯ä»¥é€šè¿‡å˜é‡æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚ PR close çš„æ—¶å€™ å‘å¸ƒ github release & tag

on:
  pull_request_target:
    branches:
      - master # æ­£å¼ç‰ˆæœ¬
    types:
      - opened
      - synchronize
      - closed
  push:
    branches:
      - master # æ­£å¼ç‰ˆæœ¬
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions: write-all

env:
  TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }} # TODO è¯·åœ¨ secrets ä¸­è®¾ç½® TOKEN_GITHUB å¹¶ä¸” TOKEN æœ‰æƒé™å‘å¸ƒ release & tag & pr & issue

jobs:
  like_admin:
    name: ç¼–è¯‘åç«¯
    runs-on: ubuntu-latest
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: ç¼–è¯‘
        run: |
          cd ./server
          mvn clean install -Dmaven.test.skip=true -f pom.xml
          find ${PWD} -name "*.jar" -exec zip -j like-admin.zip {} +

      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: like-admin.zip
          path: server/like-admin.zip
          retention-days: 5

  uniapp:
    runs-on: ubuntu-latest
    name: ç¼–è¯‘å‰ç«¯
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® node ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: æ‰“åŒ…
        run: |
          cd ./uniapp
          npm install
          npm run build:h5
          cd ..
          zip -rj uniapp.zip ./h5

      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        id: artifact-upload-step
        with:
          name: uniapp.zip
          path: uniapp.zip
          retention-days: 5

      - name: Output artifact URL
        run: echo "Artifact URL is ${{ steps.artifact-upload-step.outputs.artifact-url }}"

  Make_Release:
    # è¯¥ä»»åŠ¡å¯åœ¨ merge ä¹Ÿå°±æ˜¯ pr clone çš„æ—¶å€™ è¿›è¡Œä¸Šä¼ ä»»åŠ¡ å½“ç„¶ä¹Ÿå¯ä»¥åˆå¹¶æˆä¸€ä¸ª cli
    needs: [ like_admin, uniapp ]
    if: github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha != ''
    name: å‘å¸ƒç¼–è¯‘å¥½çš„è½¯ä»¶
    runs-on: ubuntu-latest
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æµ‹æƒé™
        run: |
          if [ "${{ env.TOKEN_GITHUB }}" == "" ]; then
            echo "TOKEN_GITHUB=${{ github.token }}" >> $GITHUB_ENV
            echo "âŒ æœªè®¾ç½® secrets.TOKEN_GITHUB å¯†ç "
          fi
      - name: æŸ¥æ‰¾é€šçŸ¥
        uses: peter-evans/find-comment@v2
        id: fc
        with:
          token: ${{ env.TOKEN_GITHUB }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: ${{ github.actor }}
          body-includes: 'This Comment was created by' # æ³¨æ„è¯¥æ–‡å­—è¦å­˜åœ¨äº æ›´æ–°è¯„è®º ä¸­çš„ body

      - name: æ›´æ–°é€šçŸ¥
        uses: peter-evans/create-or-update-comment@v3
        if: github.repository_owner	== github.actor # åªæœ‰ä»“åº“æ‹¥æœ‰è€…æ‰ä¼šæ”¶åˆ°é€šçŸ¥
        with:
          token: ${{ env.TOKEN_GITHUB }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            @${{ github.actor }} ğŸŒ¹ğŸŒ¹ğŸŒ¹

            [**Actions è¿è¡Œæ—¥å¿—**](/actions/runs/${{ github.run_id }})
            
            <sup>[**æäº¤ä¿¡æ¯**](https://github.com/${{ github.repository }}/commits/${{ github.sha }})</sup>
            
            <br>
            
            > This Comment was created by [**Create or Update Comment**](peter-evans/create-or-update-comment@v3)


      - name: ä¸‹è½½
        if: github.event.pull_request.merged == true
        uses: actions/download-artifact@v4
        with:
          path: ./
          merge-multiple: true

      - name: è§£å‹
        if: github.event.pull_request.merged == true
        run: |
          unzip like-admin.zip -d ./dist
          mv uniapp.zip ./dist

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        if: github.event.pull_request.merged == true # åªæœ‰è¢«åˆå¹¶çš„ pr æ‰ä¼š å‘å¸ƒ
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1

      - name: å‘å¸ƒ
        if: github.event.pull_request.merged == true # åªæœ‰è¢«åˆå¹¶çš„ pr æ‰ä¼š å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          files: "dist/**/*.dmg"
          body: "Update ${{ steps.get-version.outputs.version }}"
          name: "Release ${{ steps.tag_version.outputs.new_tag }}"
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          draft: false
